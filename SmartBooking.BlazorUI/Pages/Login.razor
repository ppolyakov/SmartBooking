@page "/login"
@using System.Net.Http.Json
@using SmartBooking.BlazorUI.Services
@using SmartBooking.BlazorUI.Services.Provider
@inject IHttpClientFactory ClientFactory
@inject JwtAuthStateProvider AuthProvider
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudPaper Class="p-4 max-w-sm">
    <MudText Typo="Typo.h5">Admin Login</MudText>

    <MudTextField @bind-Value="_email" Label="Email" Required="true" />
    <MudTextField @bind-Value="_password" Label="Password" InputType="InputType.Password" Required="true" />

    <MudButton OnClick="HandleLogin" Color="Color.Primary" Class="mt-4" FullWidth="true">
        Login
    </MudButton>
</MudPaper>

@code {
    private string _email = "";
    private string _password = "";

    private async Task HandleLogin()
    {
        var client = ClientFactory.CreateClient("SmartBookingAPI");
        var resp = await client.PostAsJsonAsync("auth/login", new { Email = _email, Password = _password });
        if (!resp.IsSuccessStatusCode)
        {
            Snackbar.Add("Login failed", Severity.Error);
            return;
        }

        var result = await resp.Content.ReadFromJsonAsync<LoginResult>();
        if (result?.Token is null)
        {
            Snackbar.Add("Token not received", Severity.Error);
            return;
        }

        await AuthProvider.MarkUserAsAuthenticated(result.Token);

        Nav.NavigateTo("/admin");
    }

    private class LoginResult
    {
        public string Token { get; set; } = "";
    }

}